<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MEDITRACK LIMITED - General Hospital / LASUCOM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background: #f7f7fa; margin:0; padding:0; }
  #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:999; }
  #login-box { background:#fff; padding:20px; border-radius:8px; width:300px; text-align:center; }
  input, select, button { margin:5px 0; padding:0.5em; width:90%; border-radius:4px; border:1px solid #ccc; font-size:0.9em; }
  button { background:#4f8ef7; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#3563b7; }
  #dashboard { position: fixed; top:0; left:0; width:220px; height:100%; background:#fff; border-right:1px solid #ccc; padding:10px; box-sizing:border-box; overflow-y:auto; }
  #dashboard h3 { margin-top:0; }
  #dashboard div { margin-bottom:10px; }
  #attendance-section { margin-left:230px; padding:20px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:5px; text-align:center; }
  th { background:#4f8ef7; color:#fff; }
  .status-present { background:#e6ffe6; color:#1e7e34; }
  .status-absent { background:#ffe6e6; color:#c82333; }
  .status-on-leave { background:#e6f7ff; color:#005cbf; }
  .status-late { background:#fffbe6; color:#d35400; }
  #calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; margin-top:10px; }
  .day { border:1px solid #ccc; padding:5px; text-align:center; cursor:pointer; }
  .assigned { background:#d3f7d3; }
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay">
  <div id="login-box">
    <h2>MEDITRACK LIMITED</h2>
    <p>Select Facility:</p>
    <select id="facility-select">
      <option value="">--Select Facility--</option>
      <option value="general">General Hospital</option>
      <option value="lasucom">LASUCOM</option>
    </select>
    <input type="password" id="facility-password" placeholder="Facility Password">
    <p>Select Department:</p>
    <select id="department-select">
      <option value="">--Select Department--</option>
      <option value="janitor">Janitor</option>
      <option value="security">Security</option>
    </select>
    <input type="password" id="department-password" placeholder="Department Password">
    <button id="login-btn">Login</button>
    <div id="login-msg" style="color:red; font-size:0.9em;"></div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h3>Dashboard</h3>
  <div><b>Facility:</b> <span id="dash-facility"></span></div>
  <div><b>Department:</b> <span id="dash-department"></span></div>
  <div><b>Supervisor:</b> <span id="dash-supervisor"></span></div>
  <div><b>Total Staff:</b> <span id="dash-total"></span></div>
  <div><b>Present:</b> <span id="dash-present"></span></div>
  <div><b>Absent:</b> <span id="dash-absent"></span></div>
  <div><b>Shift Editor (Admin Only)</b></div>
  <select id="shiftUser"></select>
  <div id="calendar"></div>
  <input type="password" id="admin-shift-pass" placeholder="Admin Password">
  <button id="assign-shift-btn">Assign/Remove Shift</button>
</div>

<!-- Attendance Section -->
<div id="attendance-section" style="display:none;">
  <h2>Attendance List</h2>
  <input type="text" id="new-staff-name" placeholder="Add Staff (Admin)">
  <input type="password" id="admin-pass" placeholder="Admin Password">
  <button id="add-staff-btn">Add Staff</button>
  <button id="download-summary-btn">Download Attendance PDF</button>

  <table id="attendance-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Shift</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Status</th>
        <th>Supervisor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const facilityPasswords = {general:"admin1", lasucom:"admin2"};
const departmentPasswords = {janitor:"admin1", security:"admin2"};
const adminPassword = "admin";

let facility="", department="";
let staffNames = [], attendance = [], supervisor = "";
let shifts = {}; // {staffName: [day1,day2,...]}

// ----- LOGIN -----
document.getElementById("login-btn").addEventListener("click", ()=>{
  const f = document.getElementById("facility-select").value;
  const fpass = document.getElementById("facility-password").value;
  const d = document.getElementById("department-select").value;
  const dpass = document.getElementById("department-password").value;
  const msg = document.getElementById("login-msg");

  if(!f || !d){ msg.textContent="Select both facility and department"; return; }
  if(fpass!==facilityPasswords[f]){ msg.textContent="Incorrect facility password"; return; }
  if(dpass!==departmentPasswords[d]){ msg.textContent="Incorrect department password"; return; }

  facility=f; department=d;
  document.getElementById("login-overlay").style.display="none";
  document.getElementById("dashboard").style.display="block";
  document.getElementById("attendance-section").style.display="block";
  document.getElementById("dash-facility").textContent = f==="general"?"General Hospital":"LASUCOM";
  document.getElementById("dash-department").textContent = d.charAt(0).toUpperCase()+d.slice(1);

  loadLocalState();
  renderStaffTable();
  renderDashboard();
  renderCalendar();
});
<script type="module">
  // Firebase Setup
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ----- Load Local State -----
  function loadLocalState(){
    const savedStaff = JSON.parse(localStorage.getItem(facility+"_"+department+"_staff")||"[]");
    const savedAttendance = JSON.parse(localStorage.getItem(facility+"_"+department+"_attendance")||"[]");
    const savedSupervisor = localStorage.getItem(facility+"_"+department+"_supervisor")||"";
    const savedShifts = JSON.parse(localStorage.getItem(facility+"_"+department+"_shifts")||"{}");

    staffNames = savedStaff;
    attendance = savedAttendance;
    supervisor = savedSupervisor;
    shifts = savedShifts;
  }

  function saveLocalState(){
    localStorage.setItem(facility+"_"+department+"_staff", JSON.stringify(staffNames));
    localStorage.setItem(facility+"_"+department+"_attendance", JSON.stringify(attendance));
    localStorage.setItem(facility+"_"+department+"_supervisor", supervisor);
    localStorage.setItem(facility+"_"+department+"_shifts", JSON.stringify(shifts));
  }

  // ----- Dashboard -----
  function renderDashboard(){
    document.getElementById("dash-total").textContent = staffNames.length;
    let present = attendance.filter(a=>a.status==="Present").length;
    let absent = attendance.filter(a=>a.status==="Absent").length;
    document.getElementById("dash-present").textContent = present;
    document.getElementById("dash-absent").textContent = absent;
    document.getElementById("dash-supervisor").textContent = supervisor || "-";
  }

  // ----- Staff Table -----
  function renderStaffTable(){
    const tbody = document.querySelector("#attendance-table tbody");
    tbody.innerHTML="";
    const today = new Date().getDate();
    staffNames.forEach(name=>{
      // show only staff scheduled today
      const shiftsToday = shifts[name]||[];
      if(!shiftsToday.includes(today)) return;

      let att = attendance.find(a=>a.name===name) || {name, shift:"", timeIn:"", timeOut:"", status:"Absent"};
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td><input type="text" class="shift-input" value="${att.shift}" disabled></td>
        <td><input type="time" class="time-in" value="${att.timeIn}"></td>
        <td><input type="time" class="time-out" value="${att.timeOut}"></td>
        <td>
          <select class="status-select">
            <option value="Present" ${att.status==="Present"?"selected":""}>Present</option>
            <option value="Absent" ${att.status==="Absent"?"selected":""}>Absent</option>
            <option value="On Leave" ${att.status==="On Leave"?"selected":""}>On Leave</option>
          </select>
        </td>
        <td>${supervisor||"-"}</td>
      `;
      // Update attendance on change
      tr.querySelector(".time-in").addEventListener("change", e=>{
        att.timeIn = e.target.value; updateAttendance(att);
      });
      tr.querySelector(".time-out").addEventListener("change", e=>{
        att.timeOut = e.target.value; updateAttendance(att);
      });
      tr.querySelector(".status-select").addEventListener("change", e=>{
        att.status = e.target.value; updateAttendance(att);
      });
      tbody.appendChild(tr);
    });
  }

  function updateAttendance(attObj){
    const idx = attendance.findIndex(a=>a.name===attObj.name);
    if(idx>-1) attendance[idx]=attObj; else attendance.push(attObj);
    saveLocalState();
    renderDashboard();
    saveToFirebase();
  }

  // ----- Add Staff -----
  document.getElementById("add-staff-btn").addEventListener("click", ()=>{
    const name = document.getElementById("new-staff-name").value.trim();
    const pass = document.getElementById("admin-pass").value.trim();
    if(pass!==adminPassword){ alert("Invalid admin password"); return; }
    if(!name){ alert("Enter staff name"); return; }
    if(staffNames.includes(name)){ alert("Staff already exists"); return; }
    staffNames.push(name);
    saveLocalState(); renderStaffTable(); renderDashboard();
    document.getElementById("new-staff-name").value="";
  });

  // ----- Shift Calendar -----
  function renderCalendar(){
    const calendarDiv = document.getElementById("calendar");
    calendarDiv.innerHTML="";
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1,0).getDate();
    for(let d=1; d<=daysInMonth; d++){
      const div = document.createElement("div");
      div.className="day";
      div.textContent=d;
      div.addEventListener("click", ()=>{
        const user = document.getElementById("shiftUser").value;
        const adminPass = document.getElementById("admin-shift-pass").value;
        if(adminPass!==adminPassword){ alert("Invalid admin password"); return; }
        if(!user){ alert("Select user"); return; }
        if(!shifts[user]) shifts[user]=[];
        if(shifts[user].includes(d)) shifts[user] = shifts[user].filter(x=>x!==d);
        else shifts[user].push(d);
        div.classList.toggle("assigned");
        saveLocalState(); renderStaffTable(); saveToFirebase();
      });
      calendarDiv.appendChild(div);
    }
    // mark assigned days
    document.getElementById("shiftUser").innerHTML = "";
    staffNames.forEach(name=>{
      let opt = document.createElement("option"); opt.value=name; opt.textContent=name;
      document.getElementById("shiftUser").appendChild(opt);
    });
    Object.keys(shifts).forEach(name=>{
      shifts[name].forEach(d=>{
        if(d-1<calendarDiv.children.length) calendarDiv.children[d-1].classList.add("assigned");
      });
    });
  }

  document.getElementById("assign-shift-btn").addEventListener("click", ()=>{
    renderCalendar();
  });

  // ----- PDF Download -----
  document.getElementById("download-summary-btn").addEventListener("click", ()=>{
    let html = "<h2>Attendance Summary</h2><table border='1'><tr><th>Name</th><th>Shift</th><th>Time In</th><th>Time Out</th><th>Status</th><th>Supervisor</th></tr>";
    attendance.forEach(a=>{
      html+=`<tr><td>${a.name}</td><td>${a.shift}</td><td>${a.timeIn}</td><td>${a.timeOut}</td><td>${a.status}</td><td>${supervisor||"-"}</td></tr>`;
    });
    html+="</table>";
    const win = window.open();
    win.document.write(html);
    win.document.close();
    win.print();
  });

  // ----- Firebase Sync -----
  function saveToFirebase(){
    set(ref(db, facility+"_"+department), {staff: staffNames, attendance, supervisor, shifts});
  }

  function loadFromFirebase(){
    const dbRef = ref(db);
    get(child(dbRef, facility+"_"+department)).then(snapshot=>{
      if(snapshot.exists()){
        const data = snapshot.val();
        staffNames = data.staff||[];
        attendance = data.attendance||[];
        supervisor = data.supervisor||"";
        shifts = data.shifts||{};
        saveLocalState();
        renderStaffTable(); renderDashboard(); renderCalendar();
      }
    });
    onValue(ref(db, facility+"_"+department), snapshot=>{
      const data = snapshot.val();
      if(data){
        staffNames = data.staff||[];
        attendance = data.attendance||[];
        supervisor = data.supervisor||"";
        shifts = data.shifts||{};
        saveLocalState();
        renderStaffTable(); renderDashboard(); renderCalendar();
      }
    });
  }

  // Load Firebase after login
  document.getElementById("login-btn").addEventListener("click", loadFromFirebase);
</script>
</body>
</html>