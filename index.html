<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MEDITRACK LIMITED Attendance List</title>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.24.0/firebase-database.js"></script>
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <script>
    // Initialize EmailJS
    (function(){
      emailjs.init("Wfz_vJ2NRT4YzMoJV");
    })();

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCtVgxfJliYNie4ktvtM3194P5CQJngzn4",
      authDomain: "meditrack-janitor-s-attendance.firebaseapp.com",
      databaseURL: "https://meditrack-janitor-s-attendance-default-rtdb.firebaseio.com",
      projectId: "meditrack-janitor-s-attendance",
      storageBucket: "meditrack-janitor-s-attendance.appspot.com",
      messagingSenderId: "31404846429",
      appId: "1:31404846429:web:d090dcb851b10946050cb4",
      measurementId: "G-3S7EQGVYWK"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 2em; }
    h1 { text-align: center; color: #333; }
    #date-today { text-align: right; margin-bottom: 10px; font-size: 1.1em; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin: 2em auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    th, td { padding: 0.75em; text-align: center; border-bottom: 1px solid #ececec; }
    th { background: #4f8ef7; color: #fff; }
    tr:last-child td { border-bottom: none; }
    input[type="time"], input[type="date"], input[type="text"] { width: 110px; padding: 0.3em;
            border: 1px solid #ccc; border-radius: 4px; }
    select.status, select.shift { padding: 0.4em; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 5px; }
    .status-message { font-weight: bold; padding: 0.4em; border-radius: 4px; margin-top: 3px; }
    .status-present { background: #e6ffe6; color: #1e7e34; }
    .status-absent { background: #ffe6e6; color: #c82333; }
    .status-on-leave { background: #e6f7ff; color: #005cbf; }
    .status-late, .status-late-break { background: #fffbe6; color: #d35400; }
    .status-multi-late { background: #ffe6e6; color: #b8860b; }
    button { display: block; margin: 1em auto; padding: 0.75em 2em; background: #4f8ef7; color: #fff;
             border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
    button:hover { background: #3563b7; }
    #add-staff-section, #search-section, #summary-section { max-width: 600px; margin: 0 auto 1em auto;
             background: #fff; padding: 1em 2em; border-radius: 12px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
    #summary-output { margin-top: 1em; font-size: 1em; }
  </style>
</head>
<body>
<h1>MEDITRACK LIMITED Janitor Attendance List</h1>
<div id="date-today">Date: <span id="current-date"></span></div>

<div id="add-staff-section">
  <input type="text" id="new-staff-name" placeholder="Enter new staff name">
  <button id="add-staff-btn">Add Staff</button>
</div>

<div id="search-section">
  <input type="text" id="search-name" placeholder="Search staff name">
  <button id="search-btn">Search</button>
  <button id="clear-search-btn">Clear</button>
</div>

<table id="attendance-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Shift</th>
      <th>Time In</th>
      <th>Time Out</th>
      <th>Break Out</th>
      <th>Break In</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="check-attendance">Check Attendance / Save Summary</button>

<div id="summary-section">
  <h2>View Past Attendance Summaries</h2>
  <label for="summary-date">Select date:</label>
  <input type="date" id="summary-date">
  <button id="load-summary">Load Summary</button>
  <div id="summary-output"></div>
</div>

<script>
  // Initial staff
  const initialStaffNames = ["Adebayo Elijah","Adegbenro Kudirat","Adekunle Ronke","Adeshina Rashidat","Afolabi Olawale","Alabi Hassan","Aluko joy","Amudat Lawal","Anuoluwapo Joseph","Aribo Olufemi","Awosanya Pelumi","Belewu Fathia","Delight Vincent","Hussein Rosul","Idebe Lekan","Iorhide Mariam","Ibrahim Omotoyosi","Kareem Muiz","Lawal Dasola","Misturah Disu","Ogundowo Bose","Odekun Esther","Ogunlusi Felicia","Okeshola Segun","Olarenwaju Fattimo","Osinga Temitope","Otukelu Balikis","Ouneyom Elizabeth","Salvador Meminat","Shogbola Oluwaseun","Sodiq Shukurat","Temitayo Martins","Tiamiyu Adijat"];
  
  const dbStaffRef = database.ref('staff');
  const dbAttendanceRef = database.ref('attendance');

  function createStaffRow(name, shift="morning", data={timeIn:'',timeOut:'',breakOut:'',breakIn:'',status:'Present'}) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-name', name.toLowerCase());
    tr.innerHTML = `
      <td>${name}</td>
      <td>
        <select class="shift">
          <option value="morning"${shift==='morning'?' selected':''}>Morning</option>
          <option value="night"${shift==='night'?' selected':''}>Night</option>
        </select>
      </td>
      <td><input type="time" class="time-in" value="${data.timeIn||''}"></td>
      <td><input type="time" class="time-out" value="${data.timeOut||''}"></td>
      <td><input type="time" class="break-out" value="${data.breakOut||''}"></td>
      <td><input type="time" class="break-in" value="${data.breakIn||''}"></td>
      <td>
        <select class="status">
          <option value="present"${data.status==='Present'?' selected':''}>Present</option>
          <option value="absent"${data.status==='Absent'?' selected':''}>Absent</option>
          <option value="on-leave"${data.status==='On Leave'?' selected':''}>On Leave</option>
        </select>
        <div class="status-message">${data.status||''}</div>
      </td>`;
    return tr;
  }

  function populateStaffTableFromDB(staffData, attendanceData, dateStr) {
    const tbody = document.querySelector('#attendance-table tbody');
    tbody.innerHTML = '';
    staffData.forEach(name=>{
      const attData = (attendanceData && attendanceData[name]) ? attendanceData[name] : {};
      tbody.appendChild(createStaffRow(name, attData.shift||'morning', attData));
    });
  }

  function updateAttendanceInDB(dateStr){
    const rows = document.querySelectorAll('#attendance-table tbody tr');
    const summaryData = {};
    rows.forEach(row=>{
      const name = row.cells[0].textContent;
      const shift = row.querySelector('.shift').value;
      const timeIn = row.querySelector('.time-in').value;
      const timeOut = row.querySelector('.time-out').value;
      const breakOut = row.querySelector('.break-out').value;
      const breakIn = row.querySelector('.break-in').value;
      const status = row.querySelector('.status').value;
      summaryData[name] = {shift,timeIn,timeOut,breakOut,breakIn,status};
    });
    dbAttendanceRef.child(dateStr).set(summaryData);
  }

  function initPage() {
    const today = new Date();
    const yyyy = today.getFullYear(), mm = String(today.getMonth()+1).padStart(2,'0'), dd = String(today.getDate()).padStart(2,'0');
    const todayStr = `${yyyy}-${mm}-${dd}`;
    document.getElementById('current-date').textContent = todayStr;
    document.getElementById('summary-date').value = todayStr;

    // Load staff list from DB or set initial staff
    dbStaffRef.once('value').then(snapshot=>{
      if(!snapshot.exists()){
        initialStaffNames.forEach(name=>dbStaffRef.child(name).set(true));
      }
    });

    // Listen for changes in staff
    dbStaffRef.on('value', snapshot=>{
      const staffData = snapshot.exists()?Object.keys(snapshot.val()):[];
      // Load attendance for today
      dbAttendanceRef.child(todayStr).once('value').then(attSnap=>{
        const attendanceData = attSnap.exists()?attSnap.val():{};
        populateStaffTableFromDB(staffData, attendanceData, todayStr);
      });
    });

    // Listen for changes in today's attendance in real-time
    dbAttendanceRef.child(todayStr).on('value', snapshot=>{
      const attData = snapshot.exists()?snapshot.val():{};
      const tbody = document.querySelector('#attendance-table tbody');
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(row=>{
        const name = row.cells[0].textContent;
        if(attData[name]){
          row.querySelector('.time-in').value = attData[name].timeIn||'';
          row.querySelector('.time-out').value = attData[name].timeOut||'';
          row.querySelector('.break-out').value = attData[name].breakOut||'';
          row.querySelector('.break-in').value = attData[name].breakIn||'';
          row.querySelector('.status').value = attData[name].status||'Present';
          row.querySelector('.status-message').textContent = attData[name].status||'Present';
        }
      });
    });
  }

  initPage();

  document.getElementById('add-staff-btn').addEventListener('click',()=>{
    const newName = document.getElementById('new-staff-name').value.trim();
    if(!newName) return alert('Enter staff name');
    dbStaffRef.child(newName).get().then(snap=>{
      if(snap.exists()) return alert('Staff already exists');
      dbStaffRef.child(newName).set(true);
      document.getElementById('new-staff-name').value='';
    });
  });

  document.getElementById('search-btn').addEventListener('click', function() {
    const searchValue = document.getElementById('search-name').value.trim().toLowerCase();
    document.querySelectorAll('#attendance-table tbody tr').forEach(row=>{
      row.style.display = (!searchValue || row.getAttribute('data-name').includes(searchValue)) ? '' : 'none';
    });
  });
  document.getElementById('clear-search-btn').addEventListener('click', function() {
    document.getElementById('search-name').value='';
    document.querySelectorAll('#attendance-table tbody tr').forEach(row=>row.style.display='');
  });

  document.getElementById('check-attendance').addEventListener('click',()=>{
    const today = document.getElementById('current-date').textContent;
    updateAttendanceInDB(today);
    alert('Attendance saved!');
  });

  // Auto-send at 7:00AM
  setInterval(()=>{
    const now=new Date();
    if(now.getHours()===7 && now.getMinutes()===0){
      const todayStr = document.getElementById('current-date').textContent;
      dbAttendanceRef.child(todayStr).once('value').then(snapshot=>{
        if(!snapshot.exists()) return;
        const summaryData = snapshot.val();
        const summaryText = Object.keys(summaryData).map(name=>{
          const item = summaryData[name];
          return `Name: ${name}\nShift: ${item.shift}\nTime In: ${item.timeIn||'-'}\nTime Out: ${item.timeOut||'-'}\nBreak Out: ${item.breakOut||'-'}\nBreak In: ${item.breakIn||'-'}\nStatus: ${item.status}`;
        }).join("\n\n");

        // Prevent double send
        if(localStorage.getItem('summarySentForDate')===todayStr) return;
        emailjs.send("service_itxtkoc","template_mlh2ahf",{to_email:"richieraphaels60@gmail.com",date:todayStr,summary:summaryText})
          .then(()=>{ localStorage.setItem('summarySentForDate',todayStr); })
          .catch(err=>console.log('Email send failed',err));
      });
    }
  },30000);
</script>
</body>
</html>
