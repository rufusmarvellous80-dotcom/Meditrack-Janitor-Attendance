<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MEDITRACK LIMITED Attendance List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    (function(){ emailjs.init("Wfz_vJ2NRT4YzMoJV"); })();
  </script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, addDoc,
      query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUldDoEEjByUVqsu8tbOR128GGLTrgE1Q",
      authDomain: "med-attendance-2025.firebaseapp.com",
      projectId: "med-attendance-2025",
      storageBucket: "med-attendance-2025.firebasestorage.app",
      messagingSenderId: "1044593504616",
      appId: "1:1044593504616:web:b11e2126f577a76bdca6dd"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function logAudit(action, details='', actor='PIN user') {
      try { await addDoc(collection(db, 'auditLogs'), { action, details, actor, timestamp: serverTimestamp() }); }
      catch(err){ console.error('logAudit error', err); }
    }

    async function checkAdminPIN() {
      try {
        const userPIN = prompt('Enter admin PIN:');
        if(userPIN === null) return false;
        const snap = await getDoc(doc(db, 'settings', 'admin'));
        if(!snap.exists()){ alert("Admin PIN not set in Firestore."); return false; }
        return (snap.data().pin+'') === (userPIN+'');
      } catch(err){ console.error(err); alert('Error checking PIN.'); return false; }
    }

    async function verifyPinAndLog(reason='action', actionDesc={success:'', failure:''}, actor='PIN user'){
      const ok = await checkAdminPIN();
      if(ok) await logAudit(`AUTH_SUCCESS: ${reason}`, actionDesc.success || `Authorized to ${reason}`, actor);
      else await logAudit(`AUTH_FAILED: ${reason}`, actionDesc.failure || `Failed ${reason}`, actor);
      return ok;
    }

    window.__PART_A = { db, logAudit, checkAdminPIN, verifyPinAndLog, imports: { doc, getDoc, setDoc, collection, addDoc, query, orderBy, serverTimestamp } };
  </script>

  <style>
    body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 1em; }
    h1 { text-align: center; color: #333; font-size: 1.5em; margin-bottom: 0.5em; }
    #date-today { text-align: right; margin-bottom: 10px; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin: 1em auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-size: 0.9em; }
    th, td { padding: 0.5em; text-align: center; border-bottom: 1px solid #ececec; }
    th { background: #4f8ef7; color: #fff; font-size: 0.9em; }
    tr:last-child td { border-bottom: none; }
    input[type="time"], input[type="date"], input[type="text"] { width: 100%; max-width: 110px; padding: 0.3em; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85em; }
    select.status, select.shift { padding: 0.3em; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85em; }
    .status-message { font-weight: bold; padding: 0.2em; border-radius: 4px; margin-top: 3px; font-size: 0.8em; }
    .status-present { background: #e6ffe6; color: #1e7e34; }
    .status-absent { background: #ffe6e6; color: #c82333; }
    .status-on-leave { background: #e6f7ff; color: #005cbf; }
    .status-late, .status-late-break { background: #fffbe6; color: #d35400; }
    .status-multi-late { background: #ffe6e6; color: #b8860b; }
    button { margin: 0.5em auto; padding: 0.6em 1.2em; background: #4f8ef7; color: #fff; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-block; }
    button:hover { background: #3563b7; }
    #add-staff-section, #search-section, #summary-section, #supervisor-section { max-width: 100%; margin: 0 auto 1em auto; background: #fff; padding: 1em; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
    #summary-output { margin-top: 1em; font-size: 0.9em; overflow-x: auto; }
    .table-container { width: 100%; overflow-x: auto; }
    @media (max-width: 768px) { table { font-size: 0.8em; } th, td { padding: 0.4em; } button { width: 100%; margin: 0.3em 0; } }
  </style>
</head>
<body>
<h1>MEDITRACK LIMITED Janitor Attendance List</h1>
<div id="date-today">Date: <span id="current-date"></span></div>

<div id="add-staff-section">
  <input type="text" id="new-staff-name" placeholder="Enter new staff name">
  <button id="add-staff-btn">Add Staff</button>
</div>

<div id="supervisor-section">
  <input type="text" id="supervisor-name" placeholder="Supervisor on Duty">
  <button id="add-supervisor-btn">Add Supervisor</button>
  <button id="remove-supervisor-btn">Remove Supervisor</button>
  <div id="current-supervisor">Current Supervisor: None</div>
</div>

<div id="search-section">
  <input type="text" id="search-name" placeholder="Search staff name">
  <button id="search-btn">Search</button>
  <button id="clear-search-btn">Clear</button>
</div>
<div class="table-container">
  <table id="attendance-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Shift</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Break Out</th>
        <th>Break In</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<button id="check-attendance">Check Attendance / Save Summary</button>

<div id="summary-section">
  <h2>View Past Attendance Summaries</h2>
  <label for="summary-date">Select date:</label>
  <input type="date" id="summary-date">
  <button id="load-summary">Load Summary</button>
  <div id="summary-output"></div>
</div>

<script type="module">
  let staffNames = []; // start empty

  function createStaffRow(name){
    const tr = document.createElement('tr');
    tr.setAttribute('data-name', name.toLowerCase());
    tr.innerHTML = `
      <td>${name}</td>
      <td><select class="shift"><option value="morning">Morning</option><option value="night">Night</option></select></td>
      <td><input type="time" class="time-in"></td>
      <td><input type="time" class="time-out"></td>
      <td><input type="time" class="break-out"></td>
      <td><input type="time" class="break-in"></td>
      <td>
        <select class="status"><option value="present">Present</option><option value="absent">Absent</option><option value="on-leave">On Leave</option></select>
        <div class="status-message"></div>
      </td>
      <td><button class="delete-staff-btn">Delete</button></td>
    `;
    tr.querySelector('.delete-staff-btn').addEventListener('click', async ()=>{
      const ok = await window.__PART_A.verifyPinAndLog('delete staff', {success:`Deleted ${name}`, failure:`Failed delete ${name}`});
      if(!ok) return;
      staffNames = staffNames.filter(n=>n!==name); tr.remove();
    });
    return tr;
  }

  function populateStaffTable(){
    const tbody = document.querySelector('#attendance-table tbody');
    tbody.innerHTML='';
    staffNames.forEach(name=>tbody.appendChild(createStaffRow(name)));
  }

  window.onload = ()=>{
    const today = new Date();
    const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    document.getElementById('current-date').textContent = `${yyyy}-${mm}-${dd}`;
    document.getElementById('summary-date').value = `${yyyy}-${mm}-${dd}`;
  };

  // Add staff
  document.getElementById('add-staff-btn').addEventListener('click', async ()=>{
    const newNameInput = document.getElementById('new-staff-name');
    const newName = newNameInput.value.trim();
    if(!newName){ alert('Enter staff name'); return; }
    if(staffNames.includes(newName)){ alert(`${newName} already exists`); return; }
    const ok = await window.__PART_A.verifyPinAndLog('add staff', {success:`Added ${newName}`, failure:`Failed add ${newName}`});
    if(!ok) return;
    staffNames.push(newName); populateStaffTable(); newNameInput.value='';
  });

  // Supervisor add/remove
  document.getElementById('add-supervisor-btn').addEventListener('click', async ()=>{
    const name = document.getElementById('supervisor-name').value.trim();
    if(!name){ alert('Enter supervisor name'); return; }
    const ok = await window.__PART_A.verifyPinAndLog('add supervisor', {success:`Added supervisor ${name}`, failure:`Failed add supervisor`});
    if(!ok) return;
    document.getElementById('current-supervisor').textContent = `Current Supervisor: ${name}`;
  });

  document.getElementById('remove-supervisor-btn').addEventListener('click', async ()=>{
    const ok = await window.__PART_A.verifyPinAndLog('remove supervisor', {success:`Supervisor removed`, failure:`Failed remove supervisor`});
    if(!ok) return;
    document.getElementById('current-supervisor').textContent = 'Current Supervisor: None';
  });

  // Search / clear
  document.getElementById('search-btn').addEventListener('click', ()=>{
    const searchValue=document.getElementById('search-name').value.trim().toLowerCase();
    document.querySelectorAll('#attendance-table tbody tr').forEach(row=>row.style.display=row.getAttribute('data-name').includes(searchValue)?'':'none');
  });
  document.getElementById('clear-search-btn').addEventListener('click', ()=>{ 
    document.getElementById('search-name').value=''; 
    document.querySelectorAll('#attendance-table tbody tr').forEach(row=>row.style.display=''); 
  });

  function compareTime(t1,t2){ if(!t1||!t2) return 0; const [h1,m1]=t1.split(':').map(Number); const [h2,m2]=t2.split(':').map(Number); return (h1*60+m1)-(h2*60+m2); }

  async function saveAttendanceSummary(dateStr, summaryData){
    try { await window.__PART_A.setDoc(window.__PART_A.imports.doc(window.__PART_A.db,'attendanceSummaries',dateStr), {summary: summaryData}); }
    catch(err){ console.error(err); }
  }

  async function checkAndSaveAttendance(auto=false){
    const rows=document.querySelectorAll('#attendance-table tbody tr');
    let summaryData=[];
    rows.forEach(row=>{
      if(row.style.display==='none') return;
      const name=row.cells[0].textContent;
      const shift=row.querySelector('.shift').value;
      let timeIn=row.querySelector('.time-in').value;
      let timeOut=row.querySelector('.time-out').value;
      const breakOut=row.querySelector('.break-out').value;
      const breakIn=row.querySelector('.break-in').value;
      const statusSelect=row.querySelector('.status');
      const statusMsgDiv=row.querySelector('.status-message');

      let statusMsg='', statusClass='';
      if(statusSelect.value==='absent'){ statusMsg='Absent'; statusClass='status-absent'; }
      else if(statusSelect.value==='on-leave'){ statusMsg='On Leave'; statusClass='status-on-leave'; }
      else{
        let lateToWork=false;
        if(timeIn){
          if(shift==='morning' && compareTime(timeIn,'07:10')>0) lateToWork=true;
          if(shift==='night' && compareTime(timeIn,'17:10')>0) lateToWork=true;
        } else { statusMsg='Absent'; statusClass='status-absent'; }

        if(statusMsg!=='Absent'){
          statusMsg = lateToWork ? 'Late to Work' : 'Present';
          statusClass = lateToWork ? 'status-late' : 'status-present';
        }
      }

      statusMsgDiv.textContent=statusMsg;
      statusMsgDiv.className=`status-message ${statusClass}`;
      summaryData.push({name, shift, timeIn, timeOut, breakOut, breakIn, status:statusMsg});
    });

    const today = new Date();
    const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    const todayStr=`${yyyy}-${mm}-${dd}`;
    await saveAttendanceSummary(todayStr, summaryData);

    // EmailJS send
    let summaryText=summaryData.map(item=>
      `Name: ${item.name}\nShift: ${item.shift}\nTime In: ${item.timeIn||'-'}\nTime Out: ${item.timeOut||'-'}\nBreak Out: ${item.breakOut||'-'}\nBreak In: ${item.breakIn||'-'}\nStatus: ${item.status}`
    ).join("\n\n");

    if(!auto){
      emailjs.send("service_itxtkoc","template_mlh2ahf",{to_email:"dejalizzy25@gmail.com",date:todayStr,summary:summaryText})
      .then(()=>{ alert('Attendance summary sent!'); })
      .catch(err=>{ alert('Failed to send email: '+JSON.stringify(err)); });
    }
  }

  document.getElementById('check-attendance').addEventListener('click', ()=>checkAndSaveAttendance(false));

  document.getElementById('load-summary').addEventListener('click', async ()=>{
    const dateStr=document.getElementById('summary-date').value;
    try{
      const snap = await window.__PART_A.imports.getDoc(window.__PART_A.imports.doc(window.__PART_A.db,'attendanceSummaries',dateStr));
      const summaryData = snap.exists() ? snap.data().summary : null;
      const outputDiv = document.getElementById('summary-output'); outputDiv.innerHTML='';
      if(!summaryData){ outputDiv.textContent='No attendance summary for this date.'; return; }
      let html=`<table><thead><tr><th>Name</th><th>Shift</th><th>Time In</th><th>Time Out</th><th>Break Out</th><th>Break In</th><th>Status</th></tr></thead><tbody>`;
      summaryData.forEach(item=>{ html+=`<tr><td>${item.name}</td><td>${item.shift}</td><td>${item.timeIn||'-'}</td><td>${item.timeOut||'-'}</td><td>${item.breakOut||'-'}</td><td>${item.breakIn||'-'}</td><td>${item.status}</td></tr>`; });
      html+='</tbody></table>'; outputDiv.innerHTML=html;
    } catch(err){ console.error(err); }
  });
</script>
</body>
</html>