<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MEDITRACK Attendance — Realtime</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#4f8ef7; --muted:#f7f7fa; --card:#ffffff; --danger:#d9534f; --ok:#1e7e34; --night:#005cbf;
    }
    body{
      margin:0; padding:16px; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--muted); color:#222;
    }
    .container{max-width:1100px;margin:0 auto;}
    h1{ text-align:center; margin:6px 0 12px; font-size:1.4rem; }
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px;}
    .card{background:var(--card); border-radius:10px; padding:12px; box-shadow:0 4px 18px rgba(0,0,0,0.05);}
    #date-today{font-weight:600;}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    input[type="text"], input[type="date"], input[type="time"]{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px;}
    button{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}
    button.secondary{background:#6c757d;}
    button.remove{background:var(--danger);}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 360px;} }
    table{width:100%;border-collapse:collapse;background:var(--card);border-radius:8px;overflow:hidden;}
    thead th{background:var(--blue);color:#fff;padding:10px;text-align:center;font-weight:600;font-size:14px;}
    tbody td{padding:8px;text-align:center;border-bottom:1px solid #eee;font-size:14px;}
    tbody tr.locked{opacity:0.7}
    .status-badge{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700;color:#fff;font-size:12px;}
    .status-morning{background:var(--ok);}
    .status-night{background:var(--night);}
    .status-none{background:#6c757d;}
    .small{font-size:13px;color:#555;}
    /* Mobile friendly table -> stacked cards */
    @media (max-width:700px){
      table, thead, tbody, th, td, tr { display:block; }
      thead { display:none; }
      tbody tr { margin-bottom:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.03); overflow:hidden; background:var(--card); }
      tbody td { padding:10px 12px; text-align:right; position:relative; border-bottom:none; }
      tbody td::before{ content: attr(data-label); position:absolute; left:12px; width:45%; text-align:left; font-weight:600;}
    }
    .muted{color:#666;font-size:13px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>MEDITRACK LIMITED — Janitor Attendance (Realtime)</h1>
    <div class="topbar">
      <div class="card" style="display:flex;gap:12px;align-items:center;">
        <div id="date-today">Date: <strong id="current-date"></strong></div>
        <div class="small muted">Auto-send at 07:00 AM daily</div>
      </div>

      <div class="card controls" style="align-items:center;">
        <input id="new-staff-name" type="text" placeholder="Add/Remove staff name" />
        <button id="add-staff-btn">Add Staff</button>
        <button id="remove-staff-btn" class="remove">Remove Staff</button>
        <input id="search-name" type="text" placeholder="Search staff..." />
        <button id="search-btn" class="secondary">Search</button>
        <button id="clear-search-btn" class="secondary">Clear</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" style="overflow:auto;">
        <table id="attendance-table" aria-label="attendance table">
          <thead>
            <tr>
              <th style="width:26%;">Name</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Break Out</th>
              <th>Break In</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <button id="check-attendance">Send Summary Now</button>
          </div>
          <div style="margin-top:8px;">
            <label class="small">View past date:</label><br/>
            <input id="summary-date" type="date" />
            <button id="load-summary" class="secondary">Load</button>
            <div id="summary-output" style="margin-top:10px;"></div>
          </div>
          <div style="margin-top:12px;" class="muted small">
            Notes:
            <ul>
              <li>Morning shift detected if Time In hour between 04:00–15:59</li>
              <li>Night shift detected if Time In hour between 16:00–03:59</li>
              <li>Cutoffs: Morning absent if no Time In by 07:10; Night absent if no Time In by 17:10</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG =================== */
/* EmailJS public key already known */
(function(){ emailjs.init("Wfz_vJ2NRT4YzMoJV"); })();

/* Firebase config (your web app) */
const firebaseConfig = {
  apiKey: "AIzaSyCtVgxfJliYNie4ktvtM3194P5CQJngzn4",
  authDomain: "meditrack-janitor-s-attendance.firebaseapp.com",
  databaseURL: "https://meditrack-janitor-s-attendance-default-rtdb.firebaseio.com",
  projectId: "meditrack-janitor-s-attendance",
  storageBucket: "meditrack-janitor-s-attendance.firebasestorage.app",
  messagingSenderId: "31404846429",
  appId: "1:31404846429:web:d090dcb851b10946050cb4",
  measurementId: "G-3S7EQGVYWK"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== Helpers ========== */
function todayStr(d = new Date()){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function nowTimeStr(){
  const d = new Date();
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
function compareTime(t1, t2){
  if(!t1||!t2) return 0;
  const [h1,m1]=t1.split(':').map(Number); const [h2,m2]=t2.split(':').map(Number);
  return (h1*60+m1)-(h2*60+m2);
}

/* shift detection based on timeIn hour */
function detectShiftByTime(timeIn){
  if(!timeIn) return null;
  const [h, m] = timeIn.split(':').map(Number);
  // Morning between 04:00 - 15:59, Night 16:00 - 03:59
  if(h >= 4 && h < 16) return 'Morning';
  return 'Night';
}

/* compute status message and lock decision */
function computeStatus(record){
  // record: {timeIn, timeOut, breakOut, breakIn}
  const r = record || {};
  const timeIn = r.timeIn || '';
  const breakOut = r.breakOut || '';
  const breakIn = r.breakIn || '';
  const timeOut = r.timeOut || '';
  let status = '';
  let shift = detectShiftByTime(timeIn);

  // If no timeIn, status blank (we might later mark absent at cutoffs)
  if(!timeIn){
    status = shift ? `No Time In (${shift})` : '';
    return {status, shift};
  }

  // Lateness rules:
  // Morning expected Time In window: 07:00-07:10 -> late if outside
  // Night expected Time In window: 17:00-17:10 -> late if outside
  let lateMsgs = [];
  if(shift === 'Morning'){
    if(compareTime(timeIn,'07:00') < 0 || compareTime(timeIn,'07:10') > 0){
      lateMsgs.push('Late to Work');
    }
    if(breakOut && (compareTime(breakOut,'11:00') < 0 || compareTime(breakOut,'12:00') > 0)) lateMsgs.push('Late to Break');
    if(breakIn && compareTime(breakIn,'12:00') > 0) lateMsgs.push('Late from Break');
  } else if(shift === 'Night'){
    if(compareTime(timeIn,'17:00') < 0 || compareTime(timeIn,'17:10') > 0){
      lateMsgs.push('Late to Work');
    }
    // night break window 23:00 - 00:00
    if(breakOut){
      // treat 00:00 as "00:00" -> convert minutes on day wrap
      // we'll check if breakOut is between 23:00-23:59 or 00:00 exactly
      const ok = (compareTime(breakOut,'23:00') >= 0 && compareTime(breakOut,'23:59') <= 0) || (breakOut === '00:00');
      if(!ok) lateMsgs.push('Late to Break');
    }
    if(breakIn && compareTime(breakIn,'00:00') > 0) lateMsgs.push('Late from Break');
  }

  if(lateMsgs.length === 0) status = `${shift} - Present`;
  else status = `${shift} - ${lateMsgs.join(' & ')}`;

  return {status, shift};
}

/* disable/enable inputs for a row element based on locked boolean */
function setRowLocked(tr, locked){
  if(locked){
    tr.classList.add('locked');
    tr.querySelectorAll('input').forEach(i=>i.disabled = true);
  } else {
    tr.classList.remove('locked');
    tr.querySelectorAll('input').forEach(i=>i.disabled = false);
  }
}

/* generate HTML table for email body from snapshot object */
function generateEmailTableFromObject(dataObj){
  let rows = '';
  const names = Object.keys(dataObj || {}).sort((a,b)=>a.localeCompare(b));
  names.forEach(name=>{
    const d = dataObj[name] || {};
    rows += `<tr>
      <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(name)}</td>
      <td style="padding:8px;border:1px solid #ddd;">${d.timeIn || '-'}</td>
      <td style="padding:8px;border:1px solid #ddd;">${d.timeOut || '-'}</td>
      <td style="padding:8px;border:1px solid #ddd;">${d.breakOut || '-'}</td>
      <td style="padding:8px;border:1px solid #ddd;">${d.breakIn || '-'}</td>
      <td style="padding:8px;border:1px solid #ddd;">${d.shift ? d.shift + (d.status && !d.status.includes(d.shift) ? ' — ' + d.status.replace(d.shift+' - ','') : '') : (d.status || '-')}</td>
    </tr>`;
  });

  const tableHtml = `<table style="width:100%;border-collapse:collapse;font-family:Arial,Helvetica,sans-serif;">
    <thead><tr style="background:#f6f6f6"><th style="text-align:left;padding:8px;border:1px solid #ddd;">Name</th><th style="text-align:left;padding:8px;border:1px solid #ddd;">Time In</th><th style="text-align:left;padding:8px;border:1px solid #ddd;">Time Out</th><th style="text-align:left;padding:8px;border:1px solid #ddd;">Break Out</th><th style="text-align:left;padding:8px;border:1px solid #ddd;">Break In</th><th style="text-align:left;padding:8px;border:1px solid #ddd;">Shift/Status</th></tr></thead>
    <tbody>${rows}</tbody></table>`;
  return tableHtml;
}
function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* ========== UI & Firebase wiring ========== */
const tbody = document.querySelector('#attendance-table tbody');
const currentDateEl = document.getElementById('current-date');
currentDateEl.textContent = todayStr();
document.getElementById('summary-date').value = todayStr();

/* Listen for today's attendance data in realtime and render table */
const attendanceRefForToday = db.ref(`attendance/${todayStr()}`);
attendanceRefForToday.on('value', snapshot => {
  const data = snapshot.val() || {};
  // Render ordered by name
  tbody.innerHTML = '';
  Object.keys(data).sort((a,b)=>a.localeCompare(b)).forEach(name=>{
    const rec = data[name] || {};
    const tr = document.createElement('tr');
    tr.setAttribute('data-name', name.toLowerCase());

    // compute display status & shift if necessary
    const cs = computeStatus(rec);
    const statusText = rec.status || cs.status || '';
    const shift = rec.shift || cs.shift || (rec.timeIn ? detectShiftByTime(rec.timeIn) : null);

    // create row cells (use data-label for mobile)
    tr.innerHTML = `
      <td data-label="Name">${escapeHtml(name)}</td>
      <td data-label="Time In"><input type="time" class="time-in" value="${rec.timeIn||''}"></td>
      <td data-label="Time Out"><input type="time" class="time-out" value="${rec.timeOut||''}"></td>
      <td data-label="Break Out"><input type="time" class="break-out" value="${rec.breakOut||''}"></td>
      <td data-label="Break In"><input type="time" class="break-in" value="${rec.breakIn||''}"></td>
      <td data-label="Status"><span class="status-badge ${shift==='Morning'?'status-morning':shift==='Night'?'status-night':'status-none'}">${shift ? shift : (statusText||'')}</span></td>
    `;

    // Append and set lock state
    tbody.appendChild(tr);
    setRowLocked(tr, !!rec.locked);

    // Attach input listeners (auto-save)
    const timeInEl = tr.querySelector('.time-in');
    const timeOutEl = tr.querySelector('.time-out');
    const breakOutEl = tr.querySelector('.break-out');
    const breakInEl = tr.querySelector('.break-in');

    function saveRow(){
      // determine shift and status
      const recToSave = {
        timeIn: timeInEl.value || '',
        timeOut: timeOutEl.value || '',
        breakOut: breakOutEl.value || '',
        breakIn: breakInEl.value || '',
        // compute shift + status
      };
      const computed = computeStatus(recToSave);
      recToSave.status = computed.status || '';
      recToSave.shift = computed.shift || (rec.shift || '');
      // If timeIn set => lock row (so staff can't change until next day)
      if(recToSave.timeIn && !recToSave.locked){
        recToSave.locked = true;
      } else {
        recToSave.locked = !!rec.locked;
      }
      // If record already locked in db, preserve lock
      db.ref(`attendance/${todayStr()}/${name}`).once('value').then(snap=>{
        const existing = snap.val() || {};
        // if existing.locked true, do not overwrite fields (unless admin allowed). We'll still write only non-destructive fields:
        if(existing.locked){
          // keep existing locked true and avoid changing time fields
          // but we still allow admin to change from other devices; we'll write full record here but preserve locked flag
          recToSave.locked = true;
        }
        db.ref(`attendance/${todayStr()}/${name}`).set(Object.assign({}, existing, recToSave));
      });
    }

    // Save on change
    [timeInEl,timeOutEl,breakOutEl,breakInEl].forEach(el=>{
      el.addEventListener('change', saveRow);
    });

  });
});


/* Add staff with duplicate check */
document.getElementById('add-staff-btn').addEventListener('click', ()=>{
  const name = document.getElementById('new-staff-name').value.trim();
  if(!name) return alert('Enter a staff name.');
  const ref = db.ref(`attendance/${todayStr()}/${name}`);
  ref.once('value').then(snap=>{
    if(snap.exists()){
      alert(`⚠️ Staff '${name}' already exists today!`);
    } else {
      // create initial record (unlocked)
      ref.set({timeIn:'',timeOut:'',breakOut:'',breakIn:'',status:'',shift:'',locked:false})
         .then(()=>{ document.getElementById('new-staff-name').value=''; });
    }
  });
});

/* Remove staff by name */
document.getElementById('remove-staff-btn').addEventListener('click', ()=>{
  const name = document.getElementById('new-staff-name').value.trim();
  if(!name) return alert('Enter staff name to remove.');
  const ref = db.ref(`attendance/${todayStr()}/${name}`);
  ref.once('value').then(snap=>{
    if(!snap.exists()) return alert(`No staff '${name}' found today.`);
    if(confirm(`Remove staff '${name}'? This deletes today's record.`)){
      ref.remove();
      document.getElementById('new-staff-name').value = '';
    }
  });
});

/* Search */
document.getElementById('search-btn').addEventListener('click', ()=>{
  const q = document.getElementById('search-name').value.trim().toLowerCase();
  document.querySelectorAll('#attendance-table tbody tr').forEach(tr=>{
    tr.style.display = tr.getAttribute('data-name').includes(q) ? '' : 'none';
  });
});
document.getElementById('clear-search-btn').addEventListener('click', ()=>{
  document.getElementById('search-name').value = '';
  document.querySelectorAll('#attendance-table tbody tr').forEach(tr=>tr.style.display = '');
});

/* Save & send summary ------------------------------------------------- */
let lastSentDate = null;
function sendSummaryForDate(dateStr, auto=false){
  // prevent double sending same date
  if(lastSentDate === dateStr) return;
  db.ref(`attendance/${dateStr}`).once('value').then(snap=>{
    const data = snap.val() || {};
    if(Object.keys(data).length === 0) return; // nothing to send
    const htmlTable = generateEmailTableFromObject(data);
    // EmailJS: send html table in summary_html parameter
    emailjs.send("service_itxtkoc","template_mlh2ahf",{
      to_email: "richieraphaels60@gmail.com",
      date: dateStr,
      summary: 'Attendance summary (plain) included',
      summary_html: htmlTable
    }).then(() => {
      lastSentDate = dateStr;
      console.log('Summary sent for', dateStr);
      if(!auto) alert('Attendance summary sent for ' + dateStr);
      // after sending, optionally unlock next day records logic happens naturally (new date path)
      // mark today's records as sent so other devices know (set flag)
      db.ref(`meta/lastSent`).set({date: dateStr, time: new Date().toISOString()});
    }).catch(err=>{
      console.error('Email send failed', err);
      if(!auto) alert('Failed to send email: ' + JSON.stringify(err));
    });
  });
}
document.getElementById('check-attendance').addEventListener('click', ()=> sendSummaryForDate(todayStr(), false));

/* Load past summary */
document.getElementById('load-summary').addEventListener('click', ()=>{
  const date = document.getElementById('summary-date').value;
  if(!date) return alert('Pick a date');
  db.ref(`attendance/${date}`).once('value').then(snap=>{
    const data = snap.val();
    const out = document.getElementById('summary-output');
    if(!data){ out.innerHTML = '<div class="muted">No attendance for that date.</div>'; return; }
    out.innerHTML = generateEmailTableFromObject(data);
  });
});

/* Auto-check tasks: - auto-absent at cutoffs, auto-timeout, send at 07:00 - runs every 20s */
setInterval(()=> {
  const now = new Date();
  const hh = now.getHours(), mm = now.getMinutes();
  const timeStr = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;

  // 1) Auto-send at 07:00 exactly (only once per day)
  if(hh === 7 && mm === 0){
    const dateToSend = todayStr();
    // ensure we send only once per day by checking meta/lastSent
    db.ref('meta/lastSent').once('value').then(snap => {
      const last = snap.val();
      if(!last || last.date !== dateToSend){
        sendSummaryForDate(dateToSend, true);
      }
    });
  }

  // 2) Auto-absent at cutoffs:
  // Morning cutoff: 07:10 -> mark absent if no timeIn
  // Night cutoff: 17:10 -> mark absent if no timeIn
  // We'll run this check at the minute the cutoff passes.
  if ((hh === 7 && mm === 10) || (hh === 17 && mm === 10)) {
    const cutoffType = (hh === 7 && mm === 10) ? 'morning' : 'night';
    db.ref(`attendance/${todayStr()}`).once('value').then(snap=>{
      const data = snap.val() || {};
      Object.entries(data).forEach(([name, rec])=>{
        const hasTimeIn = rec && rec.timeIn;
        const locked = rec && rec.locked;
        if(!hasTimeIn && !locked){
          // mark absent & lock
          const updated = Object.assign({}, rec, {status: 'Absent', locked: true});
          // keep shift empty or set based on expectation? We'll set based on cutoff
          updated.shift = cutoffType === 'morning' ? 'Morning' : 'Night';
          db.ref(`attendance/${todayStr()}/${name}`).set(updated);
        }
      });
    });
  }

  // 3) Auto-time-out: if current time reached 17:00 -> set timeOut=17:00 for morning records missing timeOut
  // and at 07:00 set timeOut=07:00 for night records missing timeOut
  if (hh === 17 && mm === 0) {
    db.ref(`attendance/${todayStr()}`).once('value').then(snap=>{
      const data = snap.val() || {};
      Object.entries(data).forEach(([name, rec])=>{
        const shift = rec && rec.shift ? rec.shift : detectShiftByTime(rec && rec.timeIn);
        if(shift === 'Morning' && (!rec.timeOut || rec.timeOut === '')) {
          db.ref(`attendance/${todayStr()}/${name}/timeOut`).set('17:00');
        }
      });
    });
  }
  if (hh === 7 && mm === 0) {
    db.ref(`attendance/${todayStr()}`).once('value').then(snap=>{
      const data = snap.val() || {};
      Object.entries(data).forEach(([name, rec])=>{
        const shift = rec && rec.shift ? rec.shift : detectShiftByTime(rec && rec.timeIn);
        if(shift === 'Night' && (!rec.timeOut || rec.timeOut === '')) {
          db.ref(`attendance/${todayStr()}/${name}/timeOut`).set('07:00');
        }
      });
    });
  }

}, 20000); // run every 20s

/* -------------------------------------------------------------------- */
</script>
</body>
</html>
