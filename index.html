<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MEDITRACK LIMITED Attendance</title>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCtVgxfJliYNie4ktvtM3194P5CQJngzn4",
    authDomain: "meditrack-janitor-s-attendance.firebaseapp.com",
    databaseURL: "https://meditrack-janitor-s-attendance-default-rtdb.firebaseio.com",
    projectId: "meditrack-janitor-s-attendance",
    storageBucket: "meditrack-janitor-s-attendance.firebasestorage.app",
    messagingSenderId: "31404846429",
    appId: "1:31404846429:web:d090dcb851b10946050cb4",
    measurementId: "G-3S7EQGVYWK"
  };

  // Initialize Firebase and EmailJS
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const staffRef = ref(db, "staff");
  emailjs.init("Wfz_vJ2NRT4YzMoJV");
  let emailSentToday = false;

  // Compare times helper
  function compareTime(t1, t2) {
    if (!t1 || !t2) return 0;
    const [h1, m1] = t1.split(":").map(Number);
    const [h2, m2] = t2.split(":").map(Number);
    return (h1*60 + m1) - (h2*60 + m2);
  }

  // Create table row for staff
  function createStaffRow(name) {
    const tr = document.createElement("tr");
    tr.setAttribute("data-name", name.toLowerCase());
    tr.innerHTML = `
      <td>${name}</td>
      <td><input type="time" class="time-in"></td>
      <td><input type="time" class="time-out"></td>
      <td><input type="time" class="break-out"></td>
      <td><input type="time" class="break-in"></td>
      <td>
        <select class="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="on-leave">On Leave</option>
        </select>
        <div class="status-message"></div>
      </td>
      <td><button class="remove-btn">Remove</button></td>
    `;

    tr.querySelector(".remove-btn").addEventListener("click", () => {
      if(confirm(`Remove ${name}?`)){
        onValue(staffRef, (snapshot) => {
          const staffObj = snapshot.val() || {};
          for (const key in staffObj) {
            if (staffObj[key].toLowerCase() === name.toLowerCase()) {
              remove(ref(db, "staff/" + key));
              break;
            }
          }
        }, { onlyOnce: true });
      }
    });

    return tr;
  }

  // Populate staff table
  function populateStaffTable(names) {
    const tbody = document.querySelector("#attendance-table tbody");
    tbody.innerHTML = "";
    names.forEach(name => tbody.appendChild(createStaffRow(name)));
  }

  // Load staff in real-time from Firebase
  onValue(staffRef, (snapshot) => {
    if(snapshot.exists()){
      const staffObj = snapshot.val();
      const names = Object.values(staffObj).sort((a,b)=>a.localeCompare(b));
      populateStaffTable(names);
    }
  });

  // Add staff button
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("add-staff-btn").addEventListener("click", () => {
      const newNameInput = document.getElementById("new-staff-name");
      const newName = newNameInput.value.trim();
      if(!newName) return alert("Enter staff name");

      onValue(staffRef, (snapshot)=>{
        const staffObj = snapshot.val()||{};
        const existing = Object.values(staffObj).map(n=>n.toLowerCase());
        if(existing.includes(newName.toLowerCase())){
          alert("Staff already exists!");
        } else {
          set(push(staffRef), newName);
          newNameInput.value = "";
        }
      }, { onlyOnce:true });
    });
  });

  // Auto-set timeOut and check status
  function updateStatus() {
    const now = new Date();
    const rows = document.querySelectorAll("#attendance-table tbody tr");
    rows.forEach(row=>{
      const timeIn = row.querySelector(".time-in");
      const timeOut = row.querySelector(".time-out");
      const breakOut = row.querySelector(".break-out");
      const breakIn = row.querySelector(".break-in");
      const statusSelect = row.querySelector(".status");
      const statusMsgDiv = row.querySelector(".status-message");

      let status = statusSelect.value;
      let statusMsg="", statusClass="";

      // Determine shift
      const h = now.getHours();
      let shift = "day";
      if(h>=17 || h<7) shift="night";

      // Auto timeOut for previous shift
      if(shift==="day" && h===7 && !timeOut.value) timeOut.value="07:00"; // night ends
      if(shift==="night" && h===17 && !timeOut.value) timeOut.value="17:00"; // day ends

      // Lateness logic
      let lateMessages = [];
      if(timeIn.value){
        if(shift==="day" && (compareTime(timeIn.value,"07:00")<0 || compareTime(timeIn.value,"07:10")>0)) lateMessages.push("Late to Work");
        if(shift==="night" && (compareTime(timeIn.value,"17:00")<0 || compareTime(timeIn.value,"17:10")>0)) lateMessages.push("Late to Work");
      } else if(status==="present") { statusMsg="Absent"; statusClass="status-absent"; }

      if(breakOut.value){
        if(shift==="day" && (compareTime(breakOut.value,"11:00")<0 || compareTime(breakOut.value,"12:00")>0)) lateMessages.push("Late to Break");
        if(shift==="night" && (compareTime(breakOut.value,"23:00")<0 || compareTime(breakOut.value,"00:00")>0)) lateMessages.push("Late to Break");
      }
      if(breakIn.value){
        if(shift==="day" && compareTime(breakIn.value,"12:00")>0) lateMessages.push("Late from Break");
        if(shift==="night" && compareTime(breakIn.value,"00:00")>0) lateMessages.push("Late from Break");
      }

      if(!statusMsg){
        if(lateMessages.length===0){ statusMsg="Present"; statusClass="status-present"; }
        else if(lateMessages.length===1){ statusMsg=lateMessages[0]; statusClass="status-late"; }
        else{ statusMsg=lateMessages.join(" & "); statusClass="status-multi-late"; }
      }

      statusMsgDiv.textContent=statusMsg;
      statusMsgDiv.className=`status-message ${statusClass}`;
    });
  }

  // Auto-send summary
  function sendSummary() {
    if(emailSentToday) return;
    const rows = document.querySelectorAll("#attendance-table tbody tr");
    if(rows.length===0) return;
    let summaryData=[];
    rows.forEach(row=>{
      summaryData.push({
        name: row.cells[0].textContent,
        timeIn: row.querySelector(".time-in").value||"-",
        timeOut: row.querySelector(".time-out").value||"-",
        breakOut: row.querySelector(".break-out").value||"-",
        breakIn: row.querySelector(".break-in").value||"-",
        status: row.querySelector(".status-message").textContent||row.querySelector(".status").value
      });
    });

    let tableHTML=`<table border="1" cellspacing="0" cellpadding="5"><thead><tr>
      <th>Name</th><th>Time In</th><th>Time Out</th>
      <th>Break Out</th><th>Break In</th><th>Status</th>
    </tr></thead><tbody>`;

    summaryData.forEach(item=>{
      tableHTML+=`<tr>
        <td>${item.name}</td><td>${item.timeIn}</td><td>${item.timeOut}</td>
        <td>${item.breakOut}</td><td>${item.breakIn}</td><td>${item.status}</td>
      </tr>`;
    });
    tableHTML+="</tbody></table>";

    const today=new Date().toISOString().split("T")[0];
    emailjs.send("service_itxtkoc","template_mlh2ahf",{
      to_email:"richieraphaels60@gmail.com",
      date:today,
      summary:tableHTML
    }).then(()=>{ emailSentToday=true; console.log("Email sent"); })
    .catch(err=>console.error("Email error",err));
  }

  // Auto update every minute
  setInterval(()=>{
    updateStatus();
    const now=new Date();
    if((now.getHours()===7 || now.getHours()===17) && now.getMinutes()===0) sendSummary();
  },60000);
</script>

<style>
  body { font-family:Arial,sans-serif; background:#f7f7fa; margin:0; padding:2em; }
  h1 { text-align:center; color:#333; }
  table { width:100%; border-collapse:collapse; background:#fff; margin:1em auto; }
  th,td { padding:0.6em; border:1px solid #ddd; text-align:center; }
  th { background:#4f8ef7; color:#fff; }
  button { margin:0.3em; padding:0.4em 1em; border:none; border-radius:5px; background:#4f8ef7; color:#fff; cursor:pointer; }
  button:hover { background:#3563b7; }
  input, select { padding:0.3em; border:1px solid #ccc; border-radius:4px; }
  #add-staff-section { background:#fff; padding:1em; margin:1em auto; max-width:500px; border-radius:10px; text-align:center; }
  .remove-btn { background:#e74c3c; color:white; padding:0.3em 0.8em; border:none; border-radius:5px; cursor:pointer; }
  .remove-btn:hover { background:#c0392b; }
  @media (max-width:768px){ table, th, td{ font-size:0.8em; } button{ font-size:0.9em; } }
</style>
</head>
<body>
  <h1>MEDITRACK LIMITED Attendance</h1>
  <div id="add-staff-section">
    <input type="text" id="new-staff-name" placeholder="Enter new staff name">
    <button id="add-staff-btn">Add Staff</button>
  </div>

  <table id="attendance-table">
    <thead>
      <tr>
        <th>Name</th><th>Time In</th><th>Time Out</th>
        <th>Break Out</th><th>Break In</th><th>Status</th><th>Remove</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
