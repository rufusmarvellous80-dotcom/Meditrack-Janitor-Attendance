<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MEDITRACK LIMITED - Attendance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;background:#f7f7fa;margin:0;padding:1em;}
h1{text-align:center;color:#333;font-size:1.5em;margin-bottom:0.5em;}
#login-section,#attendance-section,#shift-editor,#dashboard{max-width:1200px;margin:1em auto;padding:1em;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
input,select,button{padding:0.5em;margin:0.3em;border-radius:5px;border:1px solid #ccc;font-size:0.9em;}
button{background:#4f8ef7;color:#fff;border:none;cursor:pointer;}
button:hover{background:#3563b7;}
.table-container{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:1em;}
th,td{padding:0.5em;text-align:center;border-bottom:1px solid #ececec;}
th{background:#4f8ef7;color:#fff;}
.status-message{padding:0.2em;margin-top:2px;border-radius:4px;font-size:0.8em;}
.status-present{background:#e6ffe6;color:#1e7e34;}
.status-absent{background:#ffe6e6;color:#c82333;}
.status-on-leave{background:#e6f7ff;color:#005cbf;}
.status-late{background:#fffbe6;color:#d35400;}
.status-multi-late{background:#ffe6e6;color:#b8860b;}
.day{display:inline-block;width:30px;height:30px;line-height:30px;text-align:center;margin:2px;border:1px solid #ccc;cursor:pointer;}
.assigned{background:#4f8ef7;color:#fff;}
</style>
</head>
<body>
<h1>MEDITRACK LIMITED - General Hospital / LASUCOM</h1>

<!-- LOGIN SECTION -->
<div id="login-section">
  <h2>Login</h2>
  <label>Facility:</label>
  <select id="facility-select">
    <option value="">Select Facility</option>
    <option value="GeneralHospital">General Hospital</option>
    <option value="LASUCOM">LASUCOM</option>
  </select><br>
  <input type="password" id="facility-pass" placeholder="Facility Password"><br>
  <label>Department:</label>
  <select id="department-select">
    <option value="">Select Department</option>
    <option value="Janitor">Janitor</option>
    <option value="Security">Security</option>
  </select><br>
  <input type="password" id="department-pass" placeholder="Department Password"><br>
  <button id="login-btn">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;">
  <h2>Dashboard</h2>
  <div>Total Staff: <span id="dash-total">0</span></div>
  <div>Present: <span id="dash-present">0</span></div>
  <div>Absent: <span id="dash-absent">0</span></div>
  <div>Supervisor on Duty: <span id="dash-supervisor">-</span></div>
</div>

<!-- ATTENDANCE SECTION -->
<div id="attendance-section" style="display:none;">
  <h2>Attendance</h2>
  <div class="table-container">
    <table id="attendance-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Shift</th>
          <th>Time In</th>
          <th>Time Out</th>
          <th>Status</th>
          <th>Supervisor</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <input type="text" id="new-staff-name" placeholder="Add Staff">
  <input type="password" id="admin-pass" placeholder="Admin Password">
  <button id="add-staff-btn">Add Staff</button>
  <button id="download-summary-btn">Download Summary</button>
</div>

<!-- SHIFT EDITOR -->
<div id="shift-editor" style="display:none;">
  <h2>Shift Editor</h2>
  <select id="shiftUser"></select>
  <input type="password" id="admin-shift-pass" placeholder="Admin Password">
  <button id="assign-shift-btn">Edit Shifts</button>
  <div id="calendar"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBUldDoEEjByUVqsu8tbOR128GGLTrgE1Q",
  authDomain: "med-attendance-2025.firebaseapp.com",
  databaseURL: "https://med-attendance-2025-default-rtdb.firebaseio.com",
  projectId: "med-attendance-2025",
  storageBucket: "med-attendance-2025.firebasestorage.app",
  messagingSenderId: "1044593504616",
  appId: "1:1044593504616:web:b11e2126f577a76bdca6dd"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Admin passwords
const facilityPasswords = {GeneralHospital:"admin1", LASUCOM:"admin2"};
const departmentPasswords = {Janitor:"admin1", Security:"admin2"};
const adminPassword = "admin";

// State
let facility="", department="", staffNames=[], supervisor="";

// DOM elements
const loginSection = document.getElementById("login-section");
const attendanceSection = document.getElementById("attendance-section");
const dashboard = document.getElementById("dashboard");
const shiftEditor = document.getElementById("shift-editor");
const loginBtn = document.getElementById("login-btn");
const addStaffBtn = document.getElementById("add-staff-btn");
const downloadBtn = document.getElementById("download-summary-btn");
const dashTotal = document.getElementById("dash-total");
const dashPresent = document.getElementById("dash-present");
const dashAbsent = document.getElementById("dash-absent");
const dashSupervisor = document.getElementById("dash-supervisor");
const attendanceTable = document.getElementById("attendance-table").querySelector("tbody");
const shiftUserSelect = document.getElementById("shiftUser");
const calendarDiv = document.getElementById("calendar");

// LOGIN
loginBtn.addEventListener("click",()=>{
  const fac = document.getElementById("facility-select").value;
  const facPass = document.getElementById("facility-pass").value;
  const dept = document.getElementById("department-select").value;
  const deptPass = document.getElementById("department-pass").value;

  if(!fac || !dept){ alert("Select facility & department"); return; }
  if(facPass!==facilityPasswords[fac]){ alert("Wrong facility password"); return; }
  if(deptPass!==departmentPasswords[dept]){ alert("Wrong department password"); return; }

  facility = fac; department = dept;
  loginSection.style.display="none";
  attendanceSection.style.display="block";
  dashboard.style.display="block";
  shiftEditor.style.display="block";
  loadAttendance();
});

// Load attendance from Firebase
function loadAttendance(){
  const dbRef = ref(db, `${facility}/${department}/staff`);
  get(dbRef).then(snapshot=>{
    if(snapshot.exists()){
      staffNames = snapshot.val();
    } else staffNames = [];
    populateAttendanceTable();
    updateDashboard();
    populateShiftUsers();
    loadSavedAttendance();
  });
}

// Populate attendance table
function populateAttendanceTable(){
  attendanceTable.innerHTML="";
  staffNames.forEach(name=>{
    const tr = document.createElement("tr");
    tr.setAttribute("data-name",name);
    tr.innerHTML = `
      <td>${name}</td>
      <td><input type="text" class="shift-input"></td>
      <td><input type="time" class="time-in"></td>
      <td><input type="time" class="time-out"></td>
      <td>
        <select class="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="on-leave">On Leave</option>
        </select>
        <div class="status-message"></div>
      </td>
      <td><input type="text" class="supervisor-input" value="${supervisor}"></td>
    `;
    attendanceTable.appendChild(tr);
  });
}

// Add staff
addStaffBtn.addEventListener("click",()=>{
  const name = document.getElementById("new-staff-name").value.trim();
  const pass = document.getElementById("admin-pass").value;
  if(pass!==adminPassword){ alert("Admin password required"); return; }
  if(!name){ alert("Enter staff name"); return; }
  if(staffNames.includes(name)){ alert("Staff exists"); return; }
  staffNames.push(name);
  updateFirebaseStaff();
  populateAttendanceTable();
});

function updateFirebaseStaff(){
  set(ref(db, `${facility}/${department}/staff`), staffNames);
}

// Dashboard update
function updateDashboard(){
  dashTotal.textContent = staffNames.length;
  let present=0, absent=0;
  attendanceTable.querySelectorAll("tr").forEach(row=>{
    const status = row.querySelector(".status").value;
    if(status==="present") present++;
    else if(status==="absent") absent++;
  });
  dashPresent.textContent = present;
  dashAbsent.textContent = absent;
  dashSupervisor.textContent = supervisor || "-";
}

// Shift users
function populateShiftUsers(){
  shiftUserSelect.innerHTML="";
  staffNames.forEach(name=>{
    const opt = document.createElement("option"); opt.value=name; opt.textContent=name;
    shiftUserSelect.appendChild(opt);
  });
}

// Assign shifts
document.getElementById("assign-shift-btn").addEventListener("click",()=>{
  const pass = document.getElementById("admin-shift-pass").value;
  if(pass!==adminPassword){ alert("Admin password required"); return; }
  const user = shiftUserSelect.value;
  const shiftVal = prompt("Enter shift for "+user);
  if(!shiftVal) return;
  const tr = attendanceTable.querySelector(`tr[data-name="${user}"]`);
  if(tr) tr.querySelector(".shift-input").value = shiftVal;
  set(ref(db, `${facility}/${department}/shifts/${user}`), shiftVal);
});

// PDF Download (text-based)
downloadBtn.addEventListener("click",()=>{
  let text = "Attendance Summary - "+facility+" - "+department+"\n\n";
  attendanceTable.querySelectorAll("tr").forEach(row=>{
    const cells = row.querySelectorAll("td");
    text+=`Name: ${cells[0].textContent}, Shift: ${cells[1].querySelector("input").value}, In: ${cells[2].querySelector("input").value || "-"}, Out: ${cells[3].querySelector("input").value || "-"}, Status: ${cells[4].querySelector("select").value}, Supervisor: ${cells[5].querySelector("input").value}\n`;
  });
  const blob = new Blob([text],{type:"text/plain"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${facility}_${department}_summary.txt`;
  link.click();
});

// Update dashboard on change
attendanceTable.addEventListener("change",(e)=>updateDashboard());

// Preserve state on reload
window.addEventListener("beforeunload",()=>{
  attendanceTable.querySelectorAll("tr").forEach(row=>{
    const name=row.getAttribute("data-name");
    const shift=row.querySelector(".shift-input").value;
    const timeIn=row.querySelector(".time-in").value;
    const timeOut=row.querySelector(".time-out").value;
    const status=row.querySelector(".status").value;
    const sup=row.querySelector(".supervisor-input").value;
    const data={shift,timeIn,timeOut,status,supervisor:sup};
    set(ref(db, `${facility}/${department}/attendance/${name}`), data);
  });
});

// Load saved attendance
function loadSavedAttendance(){
  staffNames.forEach(name=>{
    get(ref(db, `${facility}/${department}/attendance/${name}`)).then(snapshot=>{
      if(snapshot.exists()){
        const tr = attendanceTable.querySelector(`tr[data-name="${name}"]`);
        if(tr){
          const data = snapshot.val();
          tr.querySelector(".shift-input").value=data.shift||"";
          tr.querySelector(".time-in").value=data.timeIn||"";
          tr.querySelector(".time-out").value=data.timeOut||"";
          tr.querySelector(".status").value=data.status||"present";
          tr.querySelector(".supervisor-input").value=data.supervisor||"";
        }
      }
    });
  });
}
</script>
</body>
</html>