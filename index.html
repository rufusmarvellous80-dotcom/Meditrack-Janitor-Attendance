<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MEDITRACK LIMITED Attendance List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Latest EmailJS SDK v4 -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("Wfz_vJ2NRT4YzMoJV");
    })();
  </script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7fa; margin: 0; padding: 1em; }
    h1 { text-align: center; color: #333; font-size: 1.5em; margin-bottom: 0.5em; }
    #date-today { text-align: right; margin-bottom: 10px; font-size: 1em; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin: 1em auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); font-size: 0.9em; }
    th, td { padding: 0.5em; text-align: center; border-bottom: 1px solid #ececec; }
    th { background: #4f8ef7; color: #fff; font-size: 0.9em; }
    tr:last-child td { border-bottom: none; }
    input[type="time"], input[type="date"], input[type="text"] { width: 100%; max-width: 110px; padding: 0.3em;
            border: 1px solid #ccc; border-radius: 4px; font-size: 0.85em; }
    select.status, select.shift { padding: 0.3em; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85em; }
    .status-message { font-weight: bold; padding: 0.2em; border-radius: 4px; margin-top: 3px; font-size: 0.8em; }
    .status-present { background: #e6ffe6; color: #1e7e34; }
    .status-absent { background: #ffe6e6; color: #c82333; }
    .status-on-leave { background: #e6f7ff; color: #005cbf; }
    .status-late, .status-late-break { background: #fffbe6; color: #d35400; }
    .status-multi-late { background: #ffe6e6; color: #b8860b; }
    button { margin: 0.5em auto; padding: 0.6em 1.2em; background: #4f8ef7; color: #fff;
             border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-block; }
    button:hover { background: #3563b7; }
    #add-staff-section, #search-section, #summary-section { max-width: 100%; margin: 0 auto 1em auto;
             background: #fff; padding: 1em; border-radius: 12px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
    #summary-output { margin-top: 1em; font-size: 0.9em; overflow-x: auto; }
    .table-container { width: 100%; overflow-x: auto; }
    @media (max-width: 768px) {
      table { font-size: 0.8em; }
      th, td { padding: 0.4em; }
      button { width: 100%; margin: 0.3em 0; }
    }
  </style>
</head>
<body>
  <h1>MEDITRACK LIMITED Janitor Attendance List</h1>
  <div id="date-today">Date: <span id="current-date"></span></div>

  <div id="add-staff-section">
    <input type="text" id="new-staff-name" placeholder="Enter new staff name">
    <button id="add-staff-btn">Add Staff</button>
  </div>

  <div id="search-section">
    <input type="text" id="search-name" placeholder="Search staff name">
    <button id="search-btn">Search</button>
    <button id="clear-search-btn">Clear</button>
  </div>

  <div class="table-container">
    <table id="attendance-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Shift</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Break Out</th>
                <th>Break In</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>
  <button id="check-attendance">Check Attendance / Save Summary</button>

  <div id="summary-section">
      <h2>View Past Attendance Summaries</h2>
      <label for="summary-date">Select date:</label>
      <input type="date" id="summary-date">
      <button id="load-summary">Load Summary</button>
      <div id="summary-output"></div>
  </div>

  <script>
    const initialStaffNames = [
      "Delight Vincent",
      "Odekun Esther",
      "Aribo Olufemi",
      "Aluko joy",
      "Awosanya Pelumi",
      "Temitayo Martins",
      "Ibrahim Omotoyosi",
      "Ouneyom Elizabeth",
      "Otukelu Balikis",
      "Olarenwaju Fattimo",
      "Kareem Muiz",
      "Okeshola Segun",
      "Misturah Disu",
      "Idebe Lekan",
      "Belewu Fathia",
      "Adegbenro Kudirat",
      "Hussein Rosul",
      "Shogbola Oluwaseun",
      "Ogundowo Bose",
      "Tiamiyu Adijat",
      "Adekunle Ronke",
      "Anuoluwapo Joseph",
      "Alabi Hassan",
      "Adeshina Rashidat",
      "Amudat Lawal",
      "Salvador Meminat",
      "Lawal Dasola",
      "Osinga Temitope",
      "Sodiq Shukurat",
      "Ogunlusi Felicia",
      "Afolabi Olawale",
      "Iorhide Mariam",
      "Adebayo Elijah"
    ];
    let staffNames = [...initialStaffNames].sort((a,b)=>a.localeCompare(b));

    function createStaffRow(name) {
      const tr = document.createElement('tr');
      tr.setAttribute('data-name', name.toLowerCase());
      tr.innerHTML = `
        <td>${name}</td>
        <td>
          <select class="shift">
            <option value="morning">Morning</option>
            <option value="night">Night</option>
          </select>
        </td>
        <td><input type="time" class="time-in"></td>
        <td><input type="time" class="time-out"></td>
        <td><input type="time" class="break-out"></td>
        <td><input type="time" class="break-in"></td>
        <td>
            <select class="status">
                <option value="present">Present</option>
                <option value="absent">Absent</option>
                <option value="on-leave">On Leave</option>
            </select>
            <div class="status-message"></div>
        </td>
        <td><button class="delete-staff-btn">Delete</button></td>
      `;

      tr.querySelector('.delete-staff-btn').addEventListener('click',()=>{
        if(confirm(`Are you sure you want to remove ${name}?`)){
          staffNames = staffNames.filter(n=>n!==name);
          tr.remove();
        }
      });

      return tr;
    }

    function populateStaffTable(names){
      const tbody = document.querySelector('#attendance-table tbody');
      tbody.innerHTML='';
      names.forEach(name=>tbody.appendChild(createStaffRow(name)));
    }

    window.onload = function(){
      populateStaffTable(staffNames);
      const today = new Date();
      const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
      const todayStr=`${yyyy}-${mm}-${dd}`;
      document.getElementById('current-date').textContent = todayStr;
      document.getElementById('summary-date').value = todayStr;
    };

    document.getElementById('add-staff-btn').addEventListener('click', function() {
      const newNameInput = document.getElementById('new-staff-name');
      const newName = newNameInput.value.trim();
      if(newName){
        if(staffNames.includes(newName)){
          alert(`${newName} already exists.`);
        } else {
          staffNames.push(newName);
          staffNames.sort((a,b)=>a.localeCompare(b));
          populateStaffTable(staffNames);
          newNameInput.value='';
        }
      } else alert('Please enter a staff name.');
    });

    document.getElementById('search-btn').addEventListener('click', function(){
      const searchValue = document.getElementById('search-name').value.trim().toLowerCase();
      document.querySelectorAll('#attendance-table tbody tr').forEach(row=>{
        row.style.display = (!searchValue || row.getAttribute('data-name').includes(searchValue)) ? '' : 'none';
      });
    });

    document.getElementById('clear-search-btn').addEventListener('click', function(){
      document.getElementById('search-name').value='';
      document.querySelectorAll('#attendance-table tbody tr').forEach(row=>row.style.display='');
    });

    function compareTime(t1,t2){ if(!t1||!t2)return 0; const [h1,m1]=t1.split(':').map(Number); const [h2,m2]=t2.split(':').map(Number); return (h1*60+m1)-(h2*60+m2); }

    function saveAttendanceSummary(dateStr,summaryData){
      let all=JSON.parse(localStorage.getItem('attendanceSummaries')||'{}');
      all[dateStr]=summaryData;
      localStorage.setItem('attendanceSummaries',JSON.stringify(all));
    }

    function checkAndSaveAttendance(auto=false){
      const rows=document.querySelectorAll('#attendance-table tbody tr');
      let summaryData=[];
      rows.forEach(row=>{
        if(row.style.display==='none') return;
        const name=row.cells[0].textContent;
        const shift=row.querySelector('.shift').value;
        let timeIn=row.querySelector('.time-in').value;
        let timeOut=row.querySelector('.time-out').value;
        const breakOut=row.querySelector('.break-out').value;
        const breakIn=row.querySelector('.break-in').value;
        const statusSelect=row.querySelector('.status');
        const statusMsgDiv=row.querySelector('.status-message');

        let statusMsg='', statusClass='';

        if(statusSelect.value==='absent'){ statusMsg='Absent'; statusClass='status-absent'; }
        else if(statusSelect.value==='on-leave'){ statusMsg='On Leave'; statusClass='status-on-leave'; }
        else{
          let lateToWork=false, lateToBreak=false, lateFromBreak=false;
          if(shift==='morning'){
            if(timeIn){
              if(compareTime(timeIn,'07:00')<0 || compareTime(timeIn,'07:10')>0) lateToWork=true;
            } else { statusMsg='Absent'; statusClass='status-absent'; }
            if(breakOut) if(compareTime(breakOut,'11:00')<0 || compareTime(breakOut,'12:00')>0) lateToBreak=true;
            if(breakIn) if(compareTime(breakIn,'12:00')>0) lateFromBreak=true;
            if(!timeOut && new Date().getHours()>=17) timeOut='17:00';
          } else {
            if(timeIn){
              if(compareTime(timeIn,'17:00')<0 || compareTime(timeIn,'17:10')>0) lateToWork=true;
            } else { statusMsg='Absent'; statusClass='status-absent'; }
            if(breakOut) if(!(compareTime(breakOut,'23:00')>=0 && compareTime(breakOut,'00:00')<=0)) lateToBreak=true;
            if(breakIn) if(compareTime(breakIn,'00:00')>0) lateFromBreak=true;
            if(!timeOut && new Date().getHours()>=7) timeOut='07:00';
          }
          if(statusMsg!=='Absent'){
            let lateMessages=[];
            if(lateToWork) lateMessages.push('Late to Work');
            if(lateToBreak) lateMessages.push('Late to Break');
            if(lateFromBreak) lateMessages.push('Late from Break');
            if(lateMessages.length===0){ statusMsg='Present'; statusClass='status-present'; }
            else if(lateMessages.length===1){ statusMsg=lateMessages[0]; statusClass='status-late'; }
            else{ statusMsg=lateMessages.join(' & '); statusClass='status-multi-late'; }
          }
        }
        statusMsgDiv.textContent=statusMsg;
        statusMsgDiv.className=`status-message ${statusClass}`;
        summaryData.push({name,shift,timeIn,timeOut,breakOut,breakIn,status:statusMsg});
      });

      const today=new Date();
      const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
      const todayStr=`${yyyy}-${mm}-${dd}`;
      saveAttendanceSummary(todayStr,summaryData);

      if(localStorage.getItem('summarySentForDate')===todayStr) return;

      let summaryText=summaryData.map(item=>
        `Name: ${item.name}\nShift: ${item.shift}\nTime In: ${item.timeIn||'-'}\nTime Out: ${item.timeOut||'-'}\nBreak Out: ${item.breakOut||'-'}\nBreak In: ${item.breakIn||'-'}\nStatus: ${item.status}`
      ).join("\n\n");

      emailjs.send("service_itxtkoc","template_mlh2ahf",{to_email:"dejalizzy25@gmail.com",date:todayStr,summary:summaryText})
      .then(()=>{ if(!auto) alert('Attendance summary sent!'); localStorage.setItem('summarySentForDate',todayStr); })
      .catch(err=>{ if(!auto) alert('Failed to send email: '+JSON.stringify(err)); });
    }

    document.getElementById('check-attendance').addEventListener('click',()=>checkAndSaveAttendance(false));

    document.getElementById('load-summary').addEventListener('click',function(){
      const dateStr=document.getElementById('summary-date').value;
      let all=JSON.parse(localStorage.getItem('attendanceSummaries')||'{}'); 
      const summaryData=all[dateStr];
      const outputDiv=document.getElementById('summary-output'); outputDiv.innerHTML='';
      if(!summaryData){ outputDiv.textContent='No attendance summary for this date.'; return; }
      let html=`<table><thead><tr><th>Name</th><th>Shift</th><th>Time In</th><th>Time Out</th><th>Break Out</th><th>Break In</th><th>Status</th></tr></thead><tbody>`;
      summaryData.forEach(item=>{ html+=`<tr><td>${item.name}</td><td>${item.shift}</td><td>${item.timeIn||'-'}</td><td>${item.timeOut||'-'}</td><td>${item.breakOut||'-'}</td><td>${item.breakIn||'-'}</td><td>${item.status}</td></tr>`; });
      html+=`</tbody></table>`; outputDiv.innerHTML=html;
    });

    // Auto-send at 7:00am daily
    setInterval(()=>{
      const now=new Date();
      if(now.getHours()===7 && now.getMinutes()===0){
        checkAndSaveAttendance(true);
      }
    },30000);
  </script>
</body>
</html>
